<% layout('layouts/boilerplate') %>
<style>
    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        border: 1px solid #ddd;
        padding: 8px;
    }

    th {
        background-color: #f2f2f2;
    }

    .btns {
        display: flex;
        align-items: center;
    }
</style>

<div class="show-page">
    <div class="product-show-container">
        <div class="product-show-content">
            <div class="product-show-image">
                <div class="product-image">
                    <img src="<%= product.images[0] %>" alt="<%= product.title %>" />
                </div>
            </div>
            <div class="product-show-details">
                <h1 class="product-show-title"><%= product.title %></h1>
                <p class="product-show-ratings"><%= product.rating %>★ <%= product.reviews.length %> Ratings & <%= product.reviews.length %> Reviews</p>
                <div class="product-show-price">
                    <span class="product-show-current-price">₹<%= product.sellingPrice %></span>
                    <span class="product-show-original-price">₹<%= product.mrpPrice %></span>
                    <span class="product-show-discount"></span>
                </div>
                <div class="product-show-available-offers">
                    <div class="product-show-available-offers-title">Available Offers</div>
                    <div class="carousel-container">
                        <div class="arrow-button arrow-button-left" onclick="scrollCarousel(-1)">&#9664;</div>
                        <div class="offer-card">
                            <div class="offer-card-title">Offer 1</div>
                            <div class="offer-card-details">Extra ₹1000 Off on ICICI Credit Cards</div>
                        </div>
                        <div class="offer-card">
                            <div class="offer-card-title">Offer 2</div>
                            <div class="offer-card-details">Partner Offer: Buy this and get additional 10% off on Rakhi gifts</div>
                        </div>
                        <div class="offer-card">
                            <div class="offer-card-title">Offer 3</div>
                            <div class="offer-card-details">Bank Offer: 5% Cashback on HDFC Credit Card</div>
                        </div>
                        <div class="arrow-button arrow-button-right" onclick="scrollCarousel(1)">&#9654;</div>
                    </div>
                </div>
                <!-- Add to Cart Button -->
                <div class="btns">
                    <button class="product-show-btn-add-to-cart" data-product-id="<%= product._id %>">Add to Cart</button>
                    <button class="product-show-btn-buy-now">Buy Now</button>
                </div>
                <div class="product-show-highlight">
                    <div class="product-show-highlight-title">Specifications</div>
                    <table>
                        <tr>
                            <th>Category</th>
                            <th>Details</th>
                        </tr>
                        <% for (let key in product.specifications) { %>
                            <tr>
                                <td><strong><%= camelCaseToTitleCase(key) %></strong></td>
                                <td>
                                    <% if (typeof product.specifications[key] === 'object') { %>
                                        <ul>
                                            <% for (let subKey in product.specifications[key]) { %>
                                                <li><strong><%= camelCaseToTitleCase(subKey) %>:</strong> <%= product.specifications[key][subKey] %></li>
                                            <% } %>
                                        </ul>
                                    <% } else { %>
                                        <%= product.specifications[key] %>
                                    <% } %>
                                </td>
                            </tr>
                        <% } %>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function scrollCarousel(direction) {
        const container = document.querySelector('.carousel-container');
        const cardWidth = document.querySelector('.offer-card').offsetWidth + 10;
        container.scrollLeft += direction * cardWidth;
    }

    document.addEventListener("DOMContentLoaded", function () {
        const sellingPrice = <%= product.sellingPrice %>;
        const mrpPrice = <%= product.mrpPrice %>;
        const discountElement = document.querySelector(".product-show-discount");

        const discountAmount = mrpPrice - sellingPrice;
        const discountPercentage = ((discountAmount / mrpPrice) * 100).toFixed(2);

        discountElement.textContent = `${discountPercentage}% off`;

        // Handle Add to Cart button click
        document.querySelector('.product-show-btn-add-to-cart').addEventListener('click', async function () {
            const button = this;
            const productId = button.getAttribute('data-product-id');
            console.log('Product ID:', productId);

            try {
                const response = await fetch('/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ productId })
                });

                if (response.status === 401) {
                    // Redirect to login page if not authenticated
                    window.location.href = '/login';
                    return;
                }

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    console.log('Response:', data);

                    if (data.success) {
                        button.textContent = 'Added to Cart';
                        setTimeout(() => {
                            button.textContent = 'Add to Cart';
                        }, 2000);
                    } else {
                        alert(data.message || 'Failed to add product to cart. Please try again.');
                    }
                } else {
                    console.error('Unexpected response format:', contentType);
                    alert('An unexpected error occurred. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            }
        });
    });
</script>
