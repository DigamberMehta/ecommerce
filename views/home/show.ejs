<% layout('layouts/boilerplate') %>
<style>
    table {
        width: 100%;
        border-collapse: collapse;
    }

    th,
    td {
        border: 1px solid #ddd;
        padding: 8px;
    }

    th {
        background-color: #f2f2f2;
    }

    .btns {
        display: flex;
        align-items: center;
    }

    .review-section {
        margin: 0 auto;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-family: "Rubik", sans-serif;
    }

    .write-review {
        margin-bottom: 40px;
        font-family: "Rubik", sans-serif;
    }

    .write-review h2,
    .reviews h2 {
        font-size: 24px;
        margin-bottom: 20px;
        color: #333;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
    }

    .review-submit {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        background-color: #28a745;
        color: white;
        font-size: 16px;
        cursor: pointer;
    }

    .review-submit:hover {
        background-color: #218838;
    }

    .reviews .review {
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #fff;
        margin-bottom: 20px;
    }

    .review h3 {
        font-size: 20px;
        margin-bottom: 10px;
        color: #333;
    }

    .review-rating {
        font-size: 18px;
        margin-bottom: 10px;
        color: #ff9900;
    }

    .review p {
        font-size: 16px;
        margin-bottom: 10px;
        color: #555;
    }

    .review small {
        font-size: 14px;
        color: #999;
    }

    .review-image {
        margin-top: 10px;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0, 0, 0);
        background-color: rgba(0, 0, 0, 0.4);
    }

    .modal.show {
        display: block;
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 2rem;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    @media (max-width: 600px) {
        .review-section {
            padding: 10px;
        }

        .write-review {
            margin-bottom: 20px;
        }
    }

    .review-images {
        display: flex;
        flex-direction: row;
    }

    .review-images-show-container {
        max-width: 215px;
        height: 180px;
        display: flex;
    }

    .user-review-image {
        max-width: 100%;
        max-height: 100%;
        margin-right: 10px;
        margin-bottom: 1rem;
    }

    .product-review-option {
        margin-left: 1rem;
        display: flex;
        align-items: center;
    }

    .product-review-option form {
        display: flex;
        margin: 0;
    }

    .product-review-option button {
        padding: 0;
        margin: 0 0.2rem;
        outline: none;
        border: none;
        background: #ffffff;
        cursor: pointer;
    }

    .user-review-action {
        display: flex;
        text-align: center;
    }

    .wishlist-btn-show button {
        margin: 0;
        padding: 0;
        background-color: white;
        border: none;
    }

    .top-show-section-heading {
        display: flex;
        justify-content: space-between;
    }

    .heart-icon {
        font-size: 1.5rem;
    }
    .show-image-preview-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.8);
}
.show-preview-content {
    margin: auto;
    display: block;
   height: 100vh;
   width: auto;
   object-fit: contain;
}
.show-close-button {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #fff;
    font-size: 40px;
    font-weight: bold;
    transition: 0.3s;
    cursor: pointer;
}
.show-close-button:hover,
.show-close-button:focus {
    color: #bbb;
    text-decoration: none;
    cursor: pointer;
}

</style>

<div class="show-page">
    <div class="product-show-container">
        <div class="product-show-content">
            <div class="product-show-image">
                <div class="show-carousel">
                  <div class="show-carousel-inner">
                    <% product.images.forEach((image, index) => { %>
                      <div class="show-carousel-item <%= index === 0 ? 'active' : '' %>">
                        <img src="<%= image %>" alt="Product Image <%= index + 1 %>">
                      </div>
                    <% }); %>
                  </div>
                  <% if (product.images.length > 1) { %>
                    <div class="show-carousel-indicators">
                      <% product.images.forEach((image, index) => { %>
                        <span class="show-indicator <%= index === 0 ? 'active' : '' %>" data-index="<%= index %>"></span>
                      <% }); %>
                    </div>
                  <% } %>
                </div>
                <% if (product.images.length > 1) { %>
                  <div class="show-thumbnails">
                    <% product.images.forEach((image, index) => { %>
                      <div class="show-thumbnail" data-index="<%= index %>">
                        <img src="<%= image %>" alt="Thumbnail <%= index + 1 %>">
                      </div>
                    <% }); %>
                  </div>
                <% } %>
              </div>
              
              
              
              
            <div class="product-show-details">
                <div class="top-show-section-heading">
                    <div>
                        <h1 class="product-show-title">
                            <%= product.title %>
                        </h1>
                    </div>
                    <div class="wishlist-btn-show">
                        <form action="/wishlist/<%= isInWishlist ? 'remove' : 'add' %>" method="POST">
                            
                            <input type="hidden" name="productId" value="<%= product._id %>">
                            <button type="submit" class="product-show-btn-wishlist <%= isInWishlist ? 'wishlist-active' : '' %>">
                                <span class="heart-icon">
                                    <%= isInWishlist ? 'â¤ï¸' : 'ðŸ¤' %>
                                </span>
                            </button>
                        </form>
                    </div>
                </div>
                <p class="product-show-ratings">
                    <%= product.rating %>â˜… <%= product.reviews.length %> Ratings & <%= product.reviews.length %> Reviews
                </p>
                <div class="product-show-price">
                    <span class="product-show-current-price">â‚¹<%= product.sellingPrice %></span>
                    <span class="product-show-original-price">â‚¹<%= product.mrpPrice %></span>
                    <span class="product-show-discount"></span>
                </div>
                <div class="product-show-available-offers">
                    <div class="product-show-available-offers-title">Available Offers</div>
                    <div class="carousel-container">
                        <div class="arrow-button arrow-button-left" onclick="scrollCarousel(-1)">&#9664;</div>
                        <div class="offer-card">
                            <div class="offer-card-title">Offer 1</div>
                            <div class="offer-card-details">Extra â‚¹1000 Off on ICICI Credit Cards</div>
                        </div>
                        <div class="offer-card">
                            <div class="offer-card-title">Offer 2</div>
                            <div class="offer-card-details">Partner Offer: Buy this and get additional 10% off on Rakhi gifts</div>
                        </div>
                        <div class="offer-card">
                            <div class="offer-card-title">Offer 3</div>
                            <div class="offer-card-details">Bank Offer: 5% Cashback on HDFC Credit Card</div>
                        </div>
                        <div class="arrow-button arrow-button-right" onclick="scrollCarousel(1)">&#9654;</div>
                    </div>
                </div>
                <div class="btns">
                    <form action="/cart/add" method="POST">
                        <input type="hidden" name="productId" value="<%= product._id %>">
                        <input type="hidden" name="quantity" value="1">
                       
                        <button type="submit" class="product-show-btn-add-to-cart">Add to Cart</button>
                    </form>
                    <form action="/checkout" method="GET">
                        <input type="hidden" name="productId" value="<%= product._id %>">
                        <input type="hidden" name="quantity" value="1">
                        <button type="submit" class="product-show-btn-buy-now">Buy Now</button>
                    </form>
                </div>
                <div class="product-show-highlight">
                    <div class="product-show-highlight-title">Specifications</div>
                    <table>
                        <tr>
                            <th>Category</th>
                            <th>Details</th>
                        </tr>
                        <% for (let key in product.specifications) { %>
                        <tr>
                            <td><strong><%= camelCaseToTitleCase(key) %></strong></td>
                            <td>
                                <% if (typeof product.specifications[key] === 'object') { %>
                                <ul>
                                    <% for (let subKey in product.specifications[key]) { %>
                                    <li><strong><%= camelCaseToTitleCase(subKey) %>:</strong> <%= product.specifications[key][subKey] %></li>
                                    <% } %>
                                </ul>
                                <% } else { %>
                                <%= product.specifications[key] %>
                                <% } %>
                            </td>
                        </tr>
                        <% } %>
                    </table>
                </div>
            </div>
        </div>

        <div className="full-width-preview">
            <div class="review-section">
                <div class="write-review">
                    <button id="openModal" class="review-submit">Write a Review</button>
                </div>
                <div id="reviewModal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h2>Write a Review</h2>
                        <form action="/products/<%= product._id %>/<%= product.slug %>/reviews" method="POST" enctype="multipart/form-data">
                            <div class="form-group">
                                <label for="review-title">Title</label>
                                <input type="text" id="review-title" name="review[title]" placeholder="Enter the title of your review">
                            </div>
                            <div class="form-group">
                                <label for="review-body">Review</label>
                                <textarea id="review-body" name="review[comment]" placeholder="Write your review here" rows="5"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="review-rating">Rating</label>
                                <input type="range" min="1" max="5" id="review-rating" name="review[rating]">
                            </div>
                            <div class="form-group">
                                <label for="review-images">Upload Images</label>
                                <input type="file" id="review-images" name="images" multiple>
                            </div>
                            <button type="submit" class="review-submit">Submit Review</button>
                        </form>
                    </div>
                </div>
                <div class="reviews">
                    <h2>Customer Reviews</h2>
                    <% product.reviews.forEach(review => { %>
                    <div class="review">
                        <h3><%= review.title %></h3>
                        <div class="review-rating">Rating: â˜…<%= review.rating %></div>
                        <div class="review-images ">
                            <% if (review.image && review.image.length > 0) { %>
                            <div class="review-images-show-container">
                                <% review.image.forEach(imageUrl => { %>
                                <img src="<%= imageUrl %>" alt="Review Image" class="review-image user-review-image" onclick="showOpenPreview('<%= imageUrl %>')">
                                <% }) %>
                            </div>
                            <% } %>
                        </div>
                        <p><%= review.comment %></p>
                        <div class="user-review-action">
                            <small><i style="color: black;">Reviewed by </i>: <%= review.user.name %></small>
                            <div class="product-review-option">
                                <form action="/products/<%= product._id %>/<%= product.slug %>/reviews/<%= review._id %>?_method=DELETE" method="POST">
                                    <button type="submit">Delete |</button>
                                </form>
                                <button class="edit-button" data-review-id="<%= review._id %>">Edit</button>
                            </div>
                        </div>
                    </div>
                    <% }) %>
                </div>
            </div>
            
            <div id="show-image-preview-modal" class="show-image-preview-modal">
                <span class="show-close-button" onclick="showClosePreview()">&times;</span>
                <img class="show-preview-content" id="show-preview-image">
            </div>

            <%- include('../partials/browsingHistory.ejs') %>
        </div>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll('.edit-button').forEach(button => {
            button.addEventListener('click', function () {
                const reviewId = this.getAttribute('data-review-id');
                window.location.href = `/products/<%= product._id %>/reviews/${reviewId}/edit`;
            });
        });

        document.getElementById('openModal').addEventListener('click', function () {
            document.getElementById('reviewModal').classList.add('show');
        });

        document.querySelector('.close').addEventListener('click', function () {
            document.getElementById('reviewModal').classList.remove('show');
        });

        const sellingPrice = <%= product.sellingPrice %>;
        const mrpPrice = <%= product.mrpPrice %>;
        const discountElement = document.querySelector(".product-show-discount");

        const discountAmount = mrpPrice - sellingPrice;
        const discountPercentage = ((discountAmount / mrpPrice) * 100).toFixed(2);

        discountElement.textContent = `${discountPercentage}% off`;
    });
    function showOpenPreview(imageSrc) {
        document.getElementById('show-image-preview-modal').style.display = 'block';
        document.getElementById('show-preview-image').src = imageSrc;
        disableScroll();
    }

    function showClosePreview() {
        document.getElementById('show-image-preview-modal').style.display = 'none';
        enableScroll();
    }

    function disableScroll() {
        document.body.style.overflow = 'hidden';
    }

    function enableScroll() {
        document.body.style.overflow = '';
    }
    document.addEventListener('DOMContentLoaded', () => {
  const carouselInner = document.querySelector('.show-carousel-inner');
  const indicators = document.querySelectorAll('.show-carousel-indicators .show-indicator');
  const thumbnails = document.querySelectorAll('.show-thumbnail');
  let currentIndex = 0;
  let startX, endX;
  let isTransitioning = false;

  const moveToImage = (index) => {
    if (isTransitioning) return;

    isTransitioning = true;
    indicators.forEach(ind => ind.classList.remove('active'));
    indicators[index].classList.add('active');
    thumbnails.forEach(thumbnail => thumbnail.classList.remove('active'));
    thumbnails[index].classList.add('active');
    carouselInner.style.transform = `translateX(-${index * 100}%)`;
    currentIndex = index;

    setTimeout(() => {
      isTransitioning = false;
    }, 500); // Assuming the transition duration is 0.5s
  };

  indicators.forEach((indicator, index) => {
    indicator.addEventListener('click', () => {
      moveToImage(index);
    });
  });

  thumbnails.forEach((thumbnail, index) => {
    thumbnail.addEventListener('click', () => {
      moveToImage(index);
    });
  });

  // Touch events for swipe functionality
  carouselInner.addEventListener('touchstart', (e) => {
    startX = e.touches[0].clientX;
    endX = startX; // Initialize endX to startX
  }, { passive: true });

  carouselInner.addEventListener('touchmove', (e) => {
    endX = e.touches[0].clientX;
    e.preventDefault(); // Prevent default touch move behavior
  }, { passive: false });

  carouselInner.addEventListener('touchend', () => {
    const threshold = 50; // Minimum swipe distance
    if (startX - endX > threshold) {
      // Swipe left
      if (currentIndex < indicators.length - 1) {
        moveToImage(currentIndex + 1);
      }
    } else if (endX - startX > threshold) {
      // Swipe right
      if (currentIndex > 0) {
        moveToImage(currentIndex - 1);
      }
    }
  });
});




</script>
