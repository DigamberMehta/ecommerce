<% layout('layouts/boilerplate') %>
<style>
.star-rating {
  display: flex;
  gap: 5px;
  cursor: pointer;
}

.star {
  font-size: 2rem;
  color: #ddd;
  cursor: pointer;
  transition: color 0.2s ease-in-out; /* Smooth transition */
}

.star.hover,
.star.selected {
  color: gold;
}



</style>

<div class="show-page">
  <div class="product-show-container">
    <div class="product-show-content">
      <div class="product-show-image">
        <div class="show-carousel">
          <div class="show-carousel-inner">
            <% product.images.forEach((image, index) => { %>
            <div class="show-carousel-item <%= index === 0 ? 'active' : '' %>">
              <img src="<%= image %>" alt="Product Image <%= index + 1 %>" />
            </div>
            <% }); %>
          </div>
          <% if (product.images.length > 1) { %>
          <div class="show-carousel-indicators">
            <% product.images.forEach((image, index) => { %>
            <span
              class="show-indicator <%= index === 0 ? 'active' : '' %>"
              data-index="<%= index %>"
            ></span>
            <% }); %>
          </div>
          <% } %>
        </div>
        <% if (product.images.length > 1) { %>
        <div class="show-thumbnails">
          <% product.images.forEach((image, index) => { %>
          <div class="show-thumbnail" data-index="<%= index %>">
            <img src="<%= image %>" alt="Thumbnail <%= index + 1 %>" />
          </div>
          <% }); %>
        </div>
        <% } %>
      </div>

      <div class="product-show-details">
        <div class="top-show-section-heading">
          <div>
            <h1 class="product-show-title-container">
            <span class="product-show-title"><%= product.title %></span>
             </h1>
          </div>
          <div class="wishlist-btn-show">
            <form
              action="/wishlist/<%= isInWishlist ? 'remove' : 'add' %>"
              method="POST"
            >
              <input
                type="hidden"
                name="productId"
                value="<%= product._id %>"
              />
              <button
                type="submit"
                class="product-show-btn-wishlist <%= isInWishlist ? 'wishlist-active' : '' %>"
              >
                <span class="heart-icon">
                  <%= isInWishlist ? '❤️' : '🤍' %>
                </span>
              </button>
            </form>
          </div>
        </div>
        <p class="product-show-ratings">
         <span class="show-rating"> <%= product.rating %> ★ </span>
       <span class="rating-deatils">  <%= product.reviews.length %> Ratings & <%=
          product.reviews.length %> Reviews </span>
        </p>
        <div class="product-show-price">
          <span class="product-show-current-price"
            >₹<%= product.sellingPrice %></span
          >
          <span class="product-show-original-price"
            >₹<%= product.mrpPrice %></span
          >
          <span class="product-show-discount"></span>
        </div>

        <div class="show-offer-container">
          <div class="show-offer-title">
            <p class="show-offer-title-heading">Available offers</p>
          </div>
          <div class="show-offers">
            <p class="show-offer-text-container">
              <i class="fa-sharp fa-solid fa-tag show-offer-tag"></i>
              <span class="showoffer-name"> Combo Offer</span> <span class="show-offer-description">Buy 3 items save 3%; Buy 4 or more save 5%</span>
            </p>
            <p class="show-offer-text-container">
              <i class="fa-sharp fa-solid fa-tag show-offer-tag"></i>
              <span class="showoffer-name"> Combo Offer</span> <span class="show-offer-description">Buy 3 items save  3%; Buy 4 or more save 5%</span>
            </p>
            <p class="show-offer-text-container">
              <i class="fa-sharp fa-solid fa-tag show-offer-tag"></i>
              <span class="showoffer-name"> Bank Offer </span> <span class="show-offer-description">Buy 3 items save  3%; Buy 4 or more save 5%</span>
            </p>
            <p class="show-offer-text-container">
              <i class="fa-sharp fa-solid fa-tag show-offer-tag"></i>
              <span class="showoffer-name"> Bank Offer </span> <span class="show-offer-description">Buy 3 items save 3%; Buy 4 or more save 5%</span> 
            </p>
          </div>
        </div>

        <div class="btns">
          <form action="/cart/add" method="POST">
            <input type="hidden" name="productId" value="<%= product._id %>" />
            <input type="hidden" name="quantity" value="1" />

            <button type="submit" class="product-show-btn-add-to-cart">
              <i class="fa-light fa-cart-shopping s-icons"></i>   Add to Cart
            </button>
          </form>
          <form action="/checkout" method="GET">
            <input type="hidden" name="productId" value="<%= product._id %>" />
            <input type="hidden" name="quantity" value="1" />
            <button type="submit" class="product-show-btn-buy-now">
              <i class="fa-sharp fa-solid fa-bolt"></i> &nbsp; Buy Now
            </button>
          </form>
        </div>



       <div class="product-features">
    <div class="highlights-section">
        <span class="section-title-highlight">Highlights</span>
        <span class="highlights-list">
            <li>Gives a Matte finish look</li>
            <li>Texture is: Liquid</li>
            <li>Quantity: 8.8 g</li>
        </span>
    </div>
    <div class="services-section">
        <span class="section-title">Services</span>
        <div class="service-item">
            Cash on Delivery available
        </div>
    </div>
</div>
<div class="important-note">
    <span class="important-note-title">Important</span>
   No Returns & Exchange
</div>

        

        <div class="show-product-description">
            <span class="product-show-description-title">Description </span>
            <span class="product-show-text-wrapper">
              <div class="product-show-description-text">
                <%= product.description %>
              </div>
            </span>
          </div>
          
  
        
        <div class="product-show-highlight">
            <div class="product-show-highlight-title">All Specifications</div>
            <table class="product-specifications-table">
              <tr>
                <th>Category</th>
                <th>Details</th>
              </tr>
              <% for (let key in product.specifications) { %>
              <tr>
                <td><span class="show-table-key-heading"><%= camelCaseToTitleCase(key) %></span></td>
                <td>
                  <% if (typeof product.specifications[key] === 'object') { %>
                  <div class="product-specifications-list">
                    <% for (let subKey in product.specifications[key]) { %>
                    <li class="product-specifications-list-item">
                      <% if (typeof subKey === 'string' && !/^\d+$/.test(subKey)) { %>
                        <span class="product-specifications-key"><%= camelCaseToTitleCase(subKey) %>:</span>
                      <% } %> 
                      <span class="product-specifications-value"><%= product.specifications[key][subKey] %></span>
                    </li>
                    <% } %>
                </div>
                  <% } else { %>
                  <span class="product-specifications-value"><%= product.specifications[key] %></span>
                  <% } %>
                </td>
              </tr>
              <% } %>
            </table>
          </div>
          
          


      </div>
    </div>

    <div className="full-width-preview">
      <div class="review-section">
        <div class="write-review">
          <button id="openModal" class="review-heading">Write a Review</button>
        </div>
        <div id="reviewModal" class="modal">
          <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Write a Review</h2>

            <form
            action="/products/<%= product._id %>/<%= product.slug %>/reviews"
            method="POST"
            enctype="multipart/form-data"
          >
            <div class="form-group">
              <label for="review-title">Title</label>
              <input
                type="text"
                id="review-title"
                name="review[title]"
                placeholder="Enter the title of your review"
              />
            </div>
            <div class="form-group">
              <label for="review-body">Review</label>
              <textarea
                id="review-body"
                name="review[comment]"
                placeholder="Write your review here"
                rows="5"
              ></textarea>
            </div>
            <div class="form-group">
              <label for="review-rating">Rating</label>
              <div class="star-rating" id="star-rating">
                <span class="star" data-value="1">&#9733;</span>
                <span class="star" data-value="2">&#9733;</span>
                <span class="star" data-value="3">&#9733;</span>
                <span class="star" data-value="4">&#9733;</span>
                <span class="star" data-value="5">&#9733;</span>
              </div>
              <input type="hidden" id="review-rating" name="review[rating]" />
            </div>
            <div class="form-group">
              <label for="review-images">Upload Images</label>
              <input type="file" id="review-images" name="images" multiple />
            </div>
            <button type="submit" class="review-submit">Submit Review</button>
          </form>
          

          </div>
        </div>
        

        <div class="reviews-container">
          <h2 class="all-reviews-section" >Rating & Reviews</h2>
         
          <% product.reviews.forEach(review => { %>
          <div class="review">
            <h3 class="customer-review-tittle"><%= review.title %></h3>
            <div class="review-rating">
              <% for (let i = 0; i < review.rating; i++) { %>
                <i class="fa fa-star"></i>
              <% } %>
            </div>
            <div class="review-images">
              <% if (review.image && review.image.length > 0) { %>
              <div class="review-images-show-container">
                <% review.image.forEach(imageUrl => { %>
                <img
                  src="<%= imageUrl %>"
                  alt="Review Image"
                  class="review-image user-review-image"
                  onclick="showOpenPreview('<%= imageUrl %>')"
                />
                <% }) %>
              </div>
              <% } %>
            </div>
            <p><%= review.comment %></p>
            <div class="user-review-action">
              <small
                ><i style="color: black">Reviewed by </i>: <%= review.user.name
                %></small
              >
              <div class="product-review-option">
                <form
                  action="/products/<%= product._id %>/<%= product.slug %>/reviews/<%= review._id %>?_method=DELETE"
                  method="POST"
                >
                  <button type="submit">Delete |</button>
                </form>
                <button class="edit-button" data-review-id="<%= review._id %>">
                  Edit
                </button>
              </div>
            </div>
          </div>
          <% }) %>
        </div>
      </div>

      <div id="show-image-preview-modal" class="show-image-preview-modal">
        <span class="show-close-button" onclick="showClosePreview()"
          >&times;</span
        >
        <img class="show-preview-content" id="show-preview-image" />
      </div>

      <%- include('../partials/browsingHistory.ejs') %>
    </div>
  </div>
</div>

<script>
      document.addEventListener("DOMContentLoaded", function () {
          document.querySelectorAll('.edit-button').forEach(button => {
              button.addEventListener('click', function () {
                  const reviewId = this.getAttribute('data-review-id');
                  window.location.href = `/products/<%= product._id %>/reviews/${reviewId}/edit`;
              });
          });

          document.getElementById('openModal').addEventListener('click', function () {
              document.getElementById('reviewModal').classList.add('show');
          });

          document.querySelector('.close').addEventListener('click', function () {
              document.getElementById('reviewModal').classList.remove('show');
          });

          const sellingPrice = <%= product.sellingPrice %>;
          const mrpPrice = <%= product.mrpPrice %>;
          const discountElement = document.querySelector(".product-show-discount");

          const discountAmount = mrpPrice - sellingPrice;
          const discountPercentage = ((discountAmount / mrpPrice) * 100).toFixed(2);

          discountElement.textContent = `${discountPercentage}% off`;
      });
      function showOpenPreview(imageSrc) {
          document.getElementById('show-image-preview-modal').style.display = 'block';
          document.getElementById('show-preview-image').src = imageSrc;
          disableScroll();
      }

      function showClosePreview() {
          document.getElementById('show-image-preview-modal').style.display = 'none';
          enableScroll();
      }

      function disableScroll() {
          document.body.style.overflow = 'hidden';
      }

      function enableScroll() {
          document.body.style.overflow = '';
      }
      document.addEventListener('DOMContentLoaded', () => {
    const carouselInner = document.querySelector('.show-carousel-inner');
    const indicators = document.querySelectorAll('.show-carousel-indicators .show-indicator');
    const thumbnails = document.querySelectorAll('.show-thumbnail');
    let currentIndex = 0;
    let startX, endX;
    let isTransitioning = false;

    const moveToImage = (index) => {
      if (isTransitioning) return;

      isTransitioning = true;
      indicators.forEach(ind => ind.classList.remove('active'));
      indicators[index].classList.add('active');
      thumbnails.forEach(thumbnail => thumbnail.classList.remove('active'));
      thumbnails[index].classList.add('active');
      carouselInner.style.transform = `translateX(-${index * 100}%)`;
      currentIndex = index;

      setTimeout(() => {
        isTransitioning = false;
      }, 500); // Assuming the transition duration is 0.5s
    };

    indicators.forEach((indicator, index) => {
      indicator.addEventListener('click', () => {
        moveToImage(index);
      });
    });

    thumbnails.forEach((thumbnail, index) => {
      thumbnail.addEventListener('click', () => {
        moveToImage(index);
      });
    });

    // Touch events for swipe functionality
    carouselInner.addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
      endX = startX; // Initialize endX to startX
    }, { passive: true });

    carouselInner.addEventListener('touchmove', (e) => {
      endX = e.touches[0].clientX;
      e.preventDefault(); // Prevent default touch move behavior
    }, { passive: false });

    carouselInner.addEventListener('touchend', () => {
      const threshold = 50; // Minimum swipe distance
      if (startX - endX > threshold) {
        // Swipe left
        if (currentIndex < indicators.length - 1) {
          moveToImage(currentIndex + 1);
        }
      } else if (endX - startX > threshold) {
        // Swipe right
        if (currentIndex > 0) {
          moveToImage(currentIndex - 1);
        }
      }
    });
  });
  document.addEventListener('DOMContentLoaded', function () {
    const stars = document.querySelectorAll('.star');
    const ratingInput = document.getElementById('review-rating');
    let selectedRating = 0;

    stars.forEach((star, index) => {
      star.addEventListener('mouseover', function () {
        highlightStars(index + 1);
      });

      star.addEventListener('mouseout', function () {
        highlightStars(selectedRating);
      });

      star.addEventListener('click', function () {
        selectedRating = index + 1;
        ratingInput.value = selectedRating;
        highlightStars(selectedRating);
      });
    });

    function highlightStars(rating) {
      stars.forEach((star, index) => {
        star.classList.toggle('hover', index < rating);
        star.classList.toggle('selected', index < selectedRating);
      });
    }
  });
</script>
